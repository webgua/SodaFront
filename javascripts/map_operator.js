var points1 =[
{'lng':121.482929014647,'lat':31.2406871510026,'count':22,'name':"人民广场-南京东路"},
{'lng':121.47420215762,'lat':31.2441613462476,'count':18,'name':"人民广场-南京东路1"},
{'lng':121.47420215762,'lat':31.236873137337,'count':18,'name':"人民广场-南京东路2"},
{'lng':121.491755002166,'lat':31.2441613462476,'count':18,'name':"人民广场-南京东路3"},
{'lng':121.491755002166,'lat':31.236873137337,'count':18,'name':"人民广场-南京东路4"},

{'lng':121.446582298406,'lat':31.1999327663924,'count':34,'name':"徐家汇"},
{'lng':121.442012142544,'lat':31.1953316124699,'count':28,'name':"徐家汇1"},
{'lng':121.442012142544,'lat':31.2047434798929,'count':28,'name':"徐家汇2"},
{'lng':121.45244636403,'lat':31.2047434798929,'count':28,'name':"徐家汇3"},
{'lng':121.45244636403,'lat':31.1953316124699,'count':28,'name':"徐家汇4"},

{'lng':121.520380649463,'lat':31.308721073519,'count':50,'name':"五角场"},
{'lng':121.512581957609,'lat':31.3012068624108,'count':40,'name':"五角场1"},
{'lng':121.512581957609,'lat':31.3137428398646,'count':40,'name':"五角场2"},
{'lng':121.526730973702,'lat':31.3012068624108,'count':40,'name':"五角场3"},
{'lng':121.526730973702,'lat':31.3137428398646,'count':40,'name':"五角场4"},

{'lng':121.483086477578,'lat':31.2307894219967,'count':31,'name':"淮海路"},
{'lng':121.480197916118,'lat':31.2293984883647,'count':25,'name':"淮海路1"},
{'lng':121.480197916118,'lat':31.2315055176991,'count':25,'name':"淮海路2"},
{'lng':121.485766220992,'lat':31.2293984883647,'count':25,'name':"淮海路3"},
{'lng':121.485766220992,'lat':31.2315055176991,'count':25,'name':"淮海路4"},

{'lng':121.464640707084,'lat':31.2221177445104,'count':12,'name':"音乐学院"},
{'lng':121.462056435591,'lat':31.2202245895834,'count':10,'name':"音乐学院1"},
{'lng':121.462056435591,'lat':31.2243621880036,'count':10,'name':"音乐学院2"},
{'lng':121.467915956179,'lat':31.2202245895834,'count':10,'name':"音乐学院3"},
{'lng':121.467915956179,'lat':31.2243621880036,'count':10,'name':"音乐学院4"},

{'lng':121.454375260443,'lat':31.2301644747387,'count':48,'name':"静安寺"},
{'lng':121.451051176922,'lat':31.227529046715,'count':39,'name':"静安寺1"},
{'lng':121.451051176922,'lat':31.2324390838576,'count':39,'name':"静安寺2"},
{'lng':121.457699119604,'lat':31.227529046715,'count':39,'name':"静安寺3"},
{'lng':121.457699119604,'lat':31.2324390838576,'count':39,'name':"静安寺4"},


{'lng':121.462833702931,'lat':31.2351377195479,'count':49,'name':"南京西路"},
{'lng':121.457265972233,'lat':31.2325294553004,'count':40,'name':"南京西路1"},
{'lng':121.457265972233,'lat':31.2377071070847,'count':40,'name':"南京西路2"},
{'lng':121.468442506448,'lat':31.2325294553004,'count':40,'name':"南京西路3"},
{'lng':121.468442506448,'lat':31.2377071070847,'count':40,'name':"南京西路4"},

{'lng':121.423738218854,'lat':31.2243712953956,'count':33,'name':"中山公园"},
{'lng':121.419651216845,'lat':31.2220056413452,'count':26,'name':"中山公园1"},
{'lng':121.419651216845,'lat':31.2261672439938,'count':26,'name':"中山公园2"},
{'lng':121.42949827096,'lat':31.2220056413452,'count':26,'name':"中山公园3"},
{'lng':121.42949827096,'lat':31.2261672439938,'count':26,'name':"中山公园4"},


{'lng':121.419416230625,'lat':31.2394432657806,'count':67,'name':"环球港"},
{'lng':121.417071882755,'lat':31.2370242508375,'count':54,'name':"环球港1"},
{'lng':121.417071882755,'lat':31.2429355474112,'count':54,'name':"环球港2"},
{'lng':121.421295271167,'lat':31.2370242508375,'count':54,'name':"环球港3"},
{'lng':121.421295271167,'lat':31.2429355474112,'count':54,'name':"环球港4"},

{'lng':121.460856041605,'lat':31.2511505737355,'count':50,'name':"上海火车站"},
{'lng':121.455733618491,'lat':31.2483543007763,'count':40,'name':"上海火车站1"},
{'lng':121.455733618491,'lat':31.2538450596848,'count':40,'name':"上海火车站2"},
{'lng':121.465492491255,'lat':31.2483543007763,'count':40,'name':"上海火车站3"},
{'lng':121.465492491255,'lat':31.2538450596848,'count':40,'name':"上海火车站4"},

{'lng':121.485085492792,'lat':31.2766342875169,'count':44,'name':"虹口足球场"},
{'lng':121.4829389403,'lat':31.2756393166786,'count':35,'name':"虹口足球场1"},
{'lng':121.4829389403,'lat':31.2779922003563,'count':35,'name':"虹口足球场2"},
{'lng':121.48747115186,'lat':31.2756393166786,'count':35,'name':"虹口足球场3"},
{'lng':121.48747115186,'lat':31.2779922003563,'count':35,'name':"虹口足球场4"},

{'lng':121.49098765882,'lat':31.2563443017892,'count':34,'name':"四川北路"},
{'lng':121.489115554581,'lat':31.2530247802596,'count':27,'name':"四川北路1"},
{'lng':121.489115554581,'lat':31.2594677669027,'count':27,'name':"四川北路2"},
{'lng':121.492722983811,'lat':31.2530247802596,'count':27,'name':"四川北路3"},
{'lng':121.492722983811,'lat':31.2594677669027,'count':27,'name':"四川北路4"},

{'lng':121.47925618411,'lat':31.2495065381322,'count':28,'name':"大悦城"},
{'lng':121.477581847573,'lat':31.2478976592706,'count':23,'name':"大悦城1"},
{'lng':121.477581847573,'lat':31.2510499448884,'count':23,'name':"大悦城2"},
{'lng':121.481074028334,'lat':31.2478976592706,'count':23,'name':"大悦城3"},
{'lng':121.481074028334,'lat':31.2510499448884,'count':23,'name':"大悦城4"},

{'lng':121.497354724613,'lat':31.2326582363389,'count':47,'name':"城隍庙"},
{'lng':121.493762346053,'lat':31.2299920694518,'count':38,'name':"城隍庙1"},
{'lng':121.493762346053,'lat':31.2360202228001,'count':38,'name':"城隍庙2"},
{'lng':121.500777138604,'lat':31.2299920694518,'count':38,'name':"城隍庙3"},
{'lng':121.500777138604,'lat':31.2360202228001,'count':38,'name':"城隍庙4"},

{'lng':121.476210713287,'lat':31.2118784389518,'count':11,'name':"打浦桥"},
{'lng':121.473538034463,'lat':31.2098221480924,'count':9,'name':"打浦桥1"},
{'lng':121.473538034463,'lat':31.2139347298111,'count':9,'name':"打浦桥2"},
{'lng':121.478883392111,'lat':31.2098221480924,'count':9,'name':"打浦桥3"},
{'lng':121.478883392111,'lat':31.2139347298111,'count':9,'name':"打浦桥4"},

{'lng':121.568209314741,'lat':31.2145767255769,'count':22,'name':"花木龙阳路"},
{'lng':121.562147634598,'lat':31.2094469915016,'count':19,'name':"花木龙阳路1"},
{'lng':121.562147634598,'lat':31.2204592540529,'count':19,'name':"花木龙阳路2"},
{'lng':121.572212661326,'lat':31.2094469915016,'count':19,'name':"花木龙阳路3"},
{'lng':121.572212661326,'lat':31.2204592540529,'count':19,'name':"花木龙阳路4"},

{'lng':121.524366204605,'lat':31.2359142073144,'count':49,'name':"八佰伴"},
{'lng':121.519860027006,'lat':31.2319694282542,'count':40,'name':"八佰伴1"},
{'lng':121.519860027006,'lat':31.2397515279293,'count':40,'name':"八佰伴2"},
{'lng':121.529201587376,'lat':31.2319694282542,'count':40,'name':"八佰伴3"},
{'lng':121.529201587376,'lat':31.2397515279293,'count':40,'name':"八佰伴4"},

{'lng':121.50727468901,'lat':31.242553835274,'count':9,'name':"陆家嘴"},
{'lng':121.50414248634,'lat':31.2400880964116,'count':7,'name':"陆家嘴1"},
{'lng':121.50414248634,'lat':31.2448474373256,'count':7,'name':"陆家嘴2"},
{'lng':121.510782750137,'lat':31.2400880964116,'count':7,'name':"陆家嘴3"},
{'lng':121.510782750137,'lat':31.2448474373256,'count':7,'name':"陆家嘴4"},

{'lng':121.585868959354,'lat':31.2629364848406,'count':30,'name':"金桥"},
{'lng':121.583398631219,'lat':31.2611198495579,'count':24,'name':"金桥1"},
{'lng':121.583398631219,'lat':31.2647937098459,'count':24,'name':"金桥2"},
{'lng':121.587794255606,'lat':31.2611198495579,'count':24,'name':"金桥3"},
{'lng':121.587794255606,'lat':31.2647937098459,'count':24,'name':"金桥4"},

{'lng':121.458447270089,'lat':31.2820343973228,'count':13,'name':"大宁"},
{'lng':121.455987900958,'lat':31.2786463892415,'count':9,'name':"大宁1"},
{'lng':121.455987900958,'lat':31.2855162835048,'count':9,'name':"大宁2"},
{'lng':121.460786393042,'lat':31.2786463892415,'count':9,'name':"大宁3"},
{'lng':121.460786393042,'lat':31.2855162835048,'count':9,'name':"大宁4"}
]

var mapHeatMax = 50;
var BCnumber = 20;
var preBCnumber = 3;
var centerPointLng = 121.479;
var centerPointLat = 31.249;
var hasGetData = false;

var data_mall1 = new Array(48);  //第1个商圈的数据
var data_mall2 = new Array(48);  //第2个商圈的数据
var data_mall3 = new Array(48);  //第3个商圈的数据

var styleJson = [
          {
                    "featureType": "water",
                    "elementType": "all",
                    "stylers": {
                              "color": "#3aadf7"
                    }
          },
          {
                    "featureType": "highway",
                    "elementType": "geometry.fill",
                    "stylers": {
                              "color": "#08304a"
                    }
          },
          {
                    "featureType": "highway",
                    "elementType": "geometry.stroke",
                    "stylers": {
                              "color": "#147a92"
                    }
          },
          {
                    "featureType": "arterial",
                    "elementType": "geometry.fill",
                    "stylers": {
                              "color": "#0e6095"
                    }
          },
          {
                    "featureType": "arterial",
                    "elementType": "geometry.stroke",
                    "stylers": {
                              "color": "#08304a"
                    }
          },
          {
                    "featureType": "local",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#08304a"
                    }
          },
          {
                    "featureType": "land",
                    "elementType": "all",
                    "stylers": {
                              "color": "#0e6095"
                    }
          },
          {
                    "featureType": "railway",
                    "elementType": "geometry.fill",
                    "stylers": {
                              "color": "#000000"
                    }
          },
          {
                    "featureType": "railway",
                    "elementType": "geometry.stroke",
                    "stylers": {
                              "color": "#08304b"
                    }
          },
          {
                    "featureType": "subway",
                    "elementType": "geometry",
                    "stylers": {
                              "lightness": -70
                    }
          },
          {
                    "featureType": "building",
                    "elementType": "geometry.fill",
                    "stylers": {
                              "color": "#000000"
                    }
          },
          {
                    "featureType": "all",
                    "elementType": "labels.text.fill",
                    "stylers": {
                              "color": "#ffffff"
                    }
          },
          {
                    "featureType": "all",
                    "elementType": "labels.text.stroke",
                    "stylers": {
                              "color": "#000000"
                    }
          },
          {
                    "featureType": "building",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#022338"
                    }
          },
          {
                    "featureType": "green",
                    "elementType": "geometry",
                    "stylers": {
                              "color": "#2877ae"
                    }
          },
          {
                    "featureType": "boundary",
                    "elementType": "all",
                    "stylers": {
                              "color": "#1e1c1c"
                    }
          },
          {
                    "featureType": "manmade",
                    "elementType": "all",
                    "stylers": {
                              "color": "#022338"
                    }
          }
]


// map initialization
var map1 = new BMap.Map("map1",{enableMapClick:false});
var point1 = new BMap.Point(121.479,31.249);
map1.centerAndZoom(point1,13);
map1.disableScrollWheelZoom();
map1.disableDoubleClickZoom();
//设置地图no可以拖拽
map1.enableDragging();
map1.setMapStyle({styleJson:styleJson});
$('#map2').css('display','block');
var map2 = new BMap.Map("map2",{enableMapClick:false});
var point2 = new BMap.Point(121.479,31.249);
map2.centerAndZoom(point2,13);
map2.disableScrollWheelZoom();
map2.enableDragging();
$('#map2').css('display','none');

var nav1_first = false;
var nav2_first = true;
var nav3_first = true;
var hasDrawPicture = false;

function nav_click1(){
     $('.li_1').css('background-color','#0E5E94');
     $('.li_2').css('background-color','#0b4a75');
     $('.li_3').css('background-color','#0b4a75');
     $('.li_4').css('background-color','#0b4a75');
     $('.li_5').css('background-color','#0b4a75');
     $('#map2').css('display','none');
     $('#map3').css('display','none');
     $('#map4').css('display','none');
     $('#map5').css('display','none');
     $('#map1').css('display','block');
     $('.view_right2').css('display','none');
     $('.view_right1').css('display','block');
}
function nav_click2(){
     $('.li_2').css('background-color','#0E5E94');
     $('.li_1').css('background-color','#0b4a75');
     $('.li_3').css('background-color','#0b4a75');
     $('.li_4').css('background-color','#0b4a75');
     $('.li_5').css('background-color','#0b4a75');
     $('#map1').css('display','none');
     $('#map3').css('display','none');
     $('#map4').css('display','none');
     $('#map5').css('display','none');
     $('#map2').css('display','block');
     if(hasGetData){
          console.log(map2.getOverlays());
          var heatmapOverlay2 = new BMapLib.HeatmapOverlay({"radius":35,"gradient":{
               '0.05': 'rgb(255,255,255)',
               '0.2': 'rgb(0,255,0)', 
               '0.5': 'rgb(255,255,00)',
               '0.7': 'rgb(255,0,0)'
          }});
          map2.addOverlay(heatmapOverlay2);
          heatmapOverlay2.setDataSet({data:points1,max:mapHeatMax});
          map2.setMapStyle({styleJson:styleJson});
          nav2_first = false;
     }
     $('.view_right1').css('display','none');
     $('.view_right2').css('display','block');
}
function nav_click3(){
     $('.li_3').css('background-color','#0E5E94');
     $('.li_1').css('background-color','#0b4a75');
     $('.li_2').css('background-color','#0b4a75');
     $('.li_4').css('background-color','#0b4a75');
     $('.li_5').css('background-color','#0b4a75');
     $('#map3').css('display','block');
     $('#map1').css('display','none');
     $('#map2').css('display','none');
     $('#map4').css('display','none');
     $('#map5').css('display','none');
     if(nav3_first){
          map3 = new BMap.Map("map3",{enableMapClick:false});
          var point3 = new BMap.Point(121.479,31.249);
          map3.centerAndZoom(point3,13);
          map3.disableScrollWheelZoom();
          map3.enableDragging();
          var heatmapOverlay3 = new BMapLib.HeatmapOverlay({"radius":35});
          map3.addOverlay(heatmapOverlay3);
          heatmapOverlay3.setDataSet({data:points1,max:50});
          map3.setMapStyle({styleJson:styleJson});
          nav3_first = false;
     }
}
function nav_click4(){
     $('.li_4').css('background-color','#0E5E94');
     $('.li_1').css('background-color','#0b4a75');
     $('.li_2').css('background-color','#0b4a75');
     $('.li_3').css('background-color','#0b4a75');
     $('.li_5').css('background-color','#0b4a75');
     $('#map4').css('display','block');
     $('#map1').css('display','none');
     $('#map2').css('display','none');
     $('#map3').css('display','none');
     $('#map5').css('display','none');
     $('.view_right1').css('display','none');
     $('.view_right2').css('display','block');
     function toHalfHour(miniute){
          if(miniute>=30 && miniute<60){
               return 3;
          }else
          return 0;
     }
     var myChart = echarts.init(document.getElementById('map4'));
     var base = +new Date(2016, 3, date.getDate()-1, date.getHours(), toHalfHour(date.getMinutes()), 0);  //2016-03-02 00:00:00
     var oneStep= 1800 * 1000;  //半小时
     var dateInPic = [];

option = {
    tooltip: {
        trigger: 'axis',
        position: function (pt) {
            return [pt[0], '10%'];
        }
    },
    title: {
        left: 'center',
        text: '商圈人流指数',
        textStyle:{
          fontSize:32,
          color:'#333'
        }
    },
    legend: {
        top: 'bottom',
        data:['意向']
    },
    xAxis: {
        type: 'category',
        boundaryGap: false,
        data: dateInPic
    },
    yAxis: {
        type: 'value',
        boundaryGap: [0, '10%']
    },
    
    series: [
        {
            name:'人民广场-南京东路',
            type:'line',
            smooth:true,
            symbol: 'none',
            sampling: 'average',
            itemStyle: {
                normal: {
                    color: 'rgb(138,43,226)'
                }
            },
            areaStyle: {
                normal: {color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgb(147,112,219)'
                    }, {
                        offset: 1,
                        color: 'rgb(138,43,226)'
                    }])
              }
            },
            data: data_mall1
        },
        {
            name:'徐家汇',
            type:'line',
            smooth:true,
            symbol: 'none',
            sampling: 'average',
            itemStyle: {
                normal: {
                    color: 'rgb(131, 175, 155)'
                }
            },
            areaStyle: {
                normal: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgb(135,206,235)'
                    }, {
                        offset: 1,
                        color: 'rgb(30,144,255)'
                    }])
                }
            },
            data: data_mall2
        },
        {
            name:'五角场',
            type:'line',
            smooth:true,
            symbol: 'none',
            sampling: 'average',
            itemStyle: {
                normal: {
                    color: 'rgb(255, 70, 131)'
                }
            },
            areaStyle: {
                normal: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                        offset: 0,
                        color: 'rgb(255, 158, 68)'
                    }, {
                        offset: 1,
                        color: 'rgb(255, 70, 131)'
                    }])
                }
            },
            data: data_mall3
        }
    ]
};
     for (var i = 1; i < 48; i++) {   //24小时一共48个点
         var now = new Date(base);
         dateInPic.push([now.getFullYear(), now.getMonth(), now.getDate(),now.get].join('/')+' '+[now.getHours(),toHalfHour(now.getMinutes())+'0'].join(':'));
         // dateInPic.push(base);
         // data_mall1.push(Math.round((Math.random() - 0.5) * 20 + data_mall1[i - 1]));  
         // data_mall2.push(Math.round((Math.random() - 0.5) * 20 + data_mall2[i - 1]));
         // data_mall3.push(Math.round((Math.random() - 0.5) * 20 + data_mall3[i - 1]));
         base += oneStep;
     }
     // 使用刚指定的配置项和数据显示图表
     myChart.setOption(option);
     $('#map4').css("background-color",'#fff');
}

function nav_click5(){
     $('.li_5').css('background-color','#0E5E94');
     $('.li_1').css('background-color','#0b4a75');
     $('.li_2').css('background-color','#0b4a75');
     $('.li_4').css('background-color','#0b4a75');
     $('.li_3').css('background-color','#0b4a75');
     $('#map5').css('display','block');
     $('#map1').css('display','none');
     $('#map2').css('display','none');
     $('#map4').css('display','none');
     $('#map3').css('display','none');
     if(!hasDrawPicture){
          drawPictures();
          hasDrawPicture = true;
     }
}

var sodaData1;
var MaxNumber;
var peoples=[];
var NumofPeo = [];
var aqi = 0;

function showPeoples(){
     $("#bcInfomation").empty();
     for(var i=0;i<BCnumber;i++){
          var nums = peoples[i]+parseInt(Math.random()*10);
          console.log(i+":"+nums);
          $("#bcInfomation").append("<div class='width5percent'>"+points1[i*5]['name']+":"+"<span>"+nums+"</span>"+"</div>");
     }
     setTimeout('showPeoples()',3000);
}

function handle_sodaData(data){
     sodaData1 = data['people'];
     // console.log(data['people'])
     var people = data['people'];
     aqi = data['aqi'];
     for(var i=0;i<BCnumber;i++){
          // console.log(people[i]['metro']);
          peoples[i] = (people[i]['metro']['in']+people[i]['metro']['out']+people[i]['unicom']+people[i]['taxi']['in']+people[i]['taxi']['out']);
     }
     showPeoples();
     // $("#bcInfomation").empty();
     // for(var i=0;i<BCnumber;i++){
     //      $("#bcInfomation").append("<div class='width5percent'>"+points1[i*5]['name']+":"+"<span>"+peoples[i]+"</span>"+"</div>");
     // }
     MaxNumber = Math.max.apply(null,peoples);

     for(var i=0;i<BCnumber;i++){
          points1[i*5]['count'] = peoples[i]/MaxNumber*mapHeatMax;
          points1[i*5+1]['count'] = peoples[i]/MaxNumber*mapHeatMax*(1-Math.random());
          points1[i*5+2]['count'] = peoples[i]/MaxNumber*mapHeatMax*(1-Math.random());
          points1[i*5+3]['count'] = peoples[i]/MaxNumber*mapHeatMax*(1-Math.random());
          points1[i*5+4]['count'] = peoples[i]/MaxNumber*mapHeatMax*(1-Math.random());
     }
     hasGetData = true;
     var heatmapOverlay1 = new BMapLib.HeatmapOverlay({"radius":35,"gradient":{
          '0.05': 'rgb(255,255,255)',
          '0.2': 'rgb(0,255,0)', 
          '0.5': 'rgb(255,255,00)',
          '0.7': 'rgb(255,0,0)'
     }});
     map1.addOverlay(heatmapOverlay1);
     heatmapOverlay1.setDataSet({data:points1,max:mapHeatMax});
     // var marker = new BMap.Marker(new BMap.Point(121.479,31.239));
     // marker.addEventListener("mouseover",attribute);
     // map1.addOverlay(marker);

     //添加mouseover事件
     var opts = new Array(BCnumber);
     // var infoWindow = new Array(20);
     for(var i=0;i<BCnumber;i++){
          opts[i]={title:'<span style="font-size:18px;color:#000">'+points1[i*5]['name']+'</span>'};
          // infoWindow[i] = new BMap.InfoWindow("<div style='line-height:1.8em;font-size:12px;'>123</div>",opts[i]);
     }

     for(var i=0;i<BCnumber;i++){
          (function(i){
               var pt = new BMap.Point(points1[i*5]['lng'], points1[i*5]['lat']);
               var myIcon = new BMap.Icon("http://202.120.188.240:80/SodaFront/images/marker.png",new BMap.Size(16,16));
               var marker2 = new BMap.Marker(pt,{icon:myIcon});  // 创建标注
               marker2.addEventListener("mouseover",function(){
                    var content = "<div style='line-height:1.8em;font-size:12px;color:#000;'>"+"<span>地铁出站人流:"+sodaData1[i]['metro']['in']+"</span><br>"
                    +"<span>地铁进站人流:"+sodaData1[i]['metro']['out']+"</span><br>"
                    +"<span>联通信号人流:"+sodaData1[i]['unicom']+"</span><br>"
                    +"<span>强生出租空车数:"+sodaData1[i]['taxi']['out']+"</span><br>"
                    +"<span>强生出租重车数:"+sodaData1[i]['taxi']['in']+"</span>"+"</div>";

                    var infoWindow = new BMap.InfoWindow(content,opts[i]);
                    this.openInfoWindow(infoWindow);
                    $('.BMap_pop div:nth-child(1) div').css('background-color','rgba(255,255,255,0.8');
                    $('.BMap_pop div:nth-child(3) div').css('background-color','rgba(255,255,255,0.8');
                    $('.BMap_pop div:nth-child(5) div').css('background-color','rgba(255,255,255,0.8');
                    $('.BMap_pop div:nth-child(7) div').css('background-color','rgba(255,255,255,0.8');
                    $('.BMap_pop div:nth-child(8) img').remove();
               });
               map1.addOverlay(marker2);
          })(i);              // 将标注添加到地图中
     }
    $('#aqi').html("<span style='font-size:18px;'>aqi:"+aqi+"</span>");

}

var currentscore = new Array(preBCnumber);
var predictscore = new Array(preBCnumber);

function getRank(score){
     if(score>95 && score<=100){
          return "预警";
     }
     if(score>75.39 && score<=95){
          return "相当拥挤";
     }else if(score<=75.39 && score>56.85){
          return "比较拥挤";
     }else if(score>35.32 && score<=56.85){
          return "一般";
     }else if(score>0 && score<=35.32){
          return "舒适";
     }
     return "参数出错了";
}

function getColorRank(score){
     if(score>95 && score<=100){
          return "#FF0000";
     }
     if(score>75.39 && score<=95){
          return "#FFA042";
     }else if(score<=75.39 && score>56.85){
          return "#FFFF37";
     }else if(score>35.32 && score<=56.85){
          return "#FFF";
     }else if(score>0 && score<=35.32){
          return "#B7FF4A";
     }
     return "#000";
}

function trendCrowed(current,predict){
     if(current<predict){
          return "增加";
     }else{
          return "减少";
     }
}

function handle_sodaScore(data){
     for(var i=0;i<preBCnumber;i++){
          currentscore[i] = data['current'][i]['score'];
          predictscore[i] = data['predict'][i]['score'];
     }

     for(var i=0;i<preBCnumber;i++){}

          //添加mouseover事件
          var opts = new Array(preBCnumber);
          // var infoWindow = new Array(20);
          for(var i=0;i<preBCnumber;i++){
               opts[i]={title:'<span style="font-size:18px;color:#000">'+points1[i*5]['name']+'</span>'};
               // infoWindow[i] = new BMap.InfoWindow("<div style='line-height:1.8em;font-size:12px;'>123</div>",opts[i]);
          }

          for(var i=0;i<preBCnumber;i++){
               (function(i){
                    var pt = new BMap.Point(points1[i*5]['lng'], points1[i*5]['lat']);
                    var myIcon = new BMap.Icon("http://202.120.188.240:80/SodaFront/images/location.png",new BMap.Size(16,16));
                    var marker2 = new BMap.Marker(pt,{icon:myIcon});  // 创建标注
                    marker2.addEventListener("mouseover",function(){
                    //      var content = "<div style='line-height:1.8em;font-size:12px;color:#000;'>"+"<span style='color:"+getColorRank(currentscore[i])+"'>当前人流指数:"+currentscore[i]+"</span><br>"
                    // +"<span>当前拥挤等级:"+getRank(currentscore[i])+"</span><br>"
                    // +"<span>预测人流指数:"+predictscore[i]+"</span><br>"
                    // +"<span>人流变化趋势:"+trendCrowed(currentscore[i],predictscore[i])+"</span><br>"+"</div>";
                         var content = "<div style='line-height:1.8em;font-size:12px;color:#000;'>"+"<span>当前人流指数:"+currentscore[i]+"</span><br>"
                    +"<span>当前拥挤等级:"+getRank(currentscore[i])+"</span><br>"
                    +"<span>预测人流指数:"+predictscore[i]+"</span><br>"
                    +"<span>人流变化趋势:"+trendCrowed(currentscore[i],predictscore[i])+"</span><br>"+"</div>";

                         var infoWindow = new BMap.InfoWindow(content,opts[i]);
                         this.openInfoWindow(infoWindow);
                         $('.BMap_pop div:nth-child(1) div').css('background-color','rgba(255,255,255,0.8');
                         $('.BMap_pop div:nth-child(3) div').css('background-color','rgba(255,255,255,0.8');
                         $('.BMap_pop div:nth-child(5) div').css('background-color','rgba(255,255,255,0.8');
                         $('.BMap_pop div:nth-child(7) div').css('background-color','rgba(255,255,255,0.8');
                         $('.BMap_pop div:nth-child(8) img').remove();
                    });
                    map2.addOverlay(marker2);
               })(i);              // 将标注添加到地图中
          }
}

function handle_sodaHistory(data){
     data_mall1 = data[0]['history'];
     data_mall2 = data[1]['history'];
     data_mall3 = data[2]['history'];
}

function drawPictures(){
          var m = [ 20 , 20 , 30 , 20 ],
               w = 960 - m[1] - m[3],
               h = 700 - m[0] - m[2];

          var x,
          y,
          duration = 2500,
          delay = 500;

     var color = d3.scale.category10();


          // var svg = d3.select("#map5").append("svg")
          //                 .attr("width", w + m[1] + m[3])
          //                 .attr("height", h + m[0] + m[2])
          //                 .append("g")
          //            .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
     var svg = d3.select("#map5 svg").append("g").attr("transform", "translate(" + m[3] + "," + m[0] + ")");
     var stocks,
          symbols;

     // A line generator, for the dark stroke.
          var line = d3.svg.line()
                          .interpolate("basis")
                              .x(function(d) { return x(d.date); })
                              .y(function(d) { return y(d.price); });

          // A line generator, for the dark stroke.
          var axis = d3.svg.line()
                          .interpolate("basis")
                               .x(function(d) { return x(d.date); })
                               .y(h);

          // A area generator, for the dark stroke.
          var area = d3.svg.area()
                          .interpolate("basis")
                          .x(function(d) { return x(d.date); })
                          .y1(function(d) { return y(d.price); });

     d3.csv("test.csv", function(data) {
               var parse = d3.time.format("%Y %m %d %H %M").parse;

               // Nest stock values by symbol.
                symbols = d3.nest()
                               .key(function(d) { return d.symbol; })
                               .entries(stocks = data);

               // Parse dates and numbers. We assume values are sorted by date.
              // Also compute the maximum price per symbol, needed for the y-domain.
               symbols.forEach(function(s) {
               s.values.forEach(function(d) { d.date = parse(d.date); d.price = +d.price; });
               s.maxPrice = d3.max(s.values, function(d) { return d.price; });
               s.sumPrice = d3.sum(s.values, function(d) { return d.price; });
               });

          // Sort by maximum price, descending.
               symbols.sort(function(a, b) { return b.maxPrice - a.maxPrice; });

             var g = svg.selectAll("g")
                           .data(symbols)
                      .enter().append("g")
                      .attr("class", "symbol");

            setTimeout(lines, duration);
          });


     function lines(){
          x = d3.time.scale().range([0,w-60]);
          y = d3.scale.linear().range([h/4-20,0]);

          // Compute the minimum and maximum date across symbols.
               x.domain([
               d3.min(symbols, function(d) { return d.values[0].date; }),
                    d3.max(symbols, function(d) { return d.values[d.values.length - 1].date; })
               ]);
               var g = svg.selectAll(".symbol")
                            .attr("transform", function(d, i) { return "translate(0," + (i * h / 4 + 10) + ")"; });

               g.each(function(d) {
                    var e = d3.select(this);

                    e.append("path").attr('class','line');
                    e.append("circle").attr('r',5).style("fill",function(d){return color(d.key);}).style("stroke","#000").style("stroke-width",'2px');
                    e.append("text").attr("x",12).attr("dy",".31em").text(d.key);
               });

               function draw(k) {
               g.each(function(d) {
                    var e = d3.select(this);
                         y.domain([0, d.maxPrice]);
                         e.select("path").attr("d", function(d) { return line(d.values.slice(0, k + 1)); });
                         // e.select("path").attr("d", function(d) { console.log(d); });
                         e.selectAll("circle, text").data(function(d) { return [d.values[k], d.values[k]]; }).attr("transform", function(d) { return "translate(" + x(d.date) + "," + y(d.price) + ")"; });
               });
               }

               var k = 1, n = symbols[0].values.length;
               console.log(n);
               d3.timer(function() {
               draw(k);
               if ((k += 2) >= n - 1) {
                         draw(n - 1);
                         setTimeout(horizons, 500);
                         return true;
               }
               });
     }

     function horizons(){
          svg.insert("defs", ".symbol").append("clipPath").attr("id", "clip").append("rect").attr("width", w).attr("height", h / 4 - 20);

               var color = d3.scale.ordinal().range(["#c6dbef", "#9ecae1", "#6baed6"]);

                 var g = svg.selectAll(".symbol")
                     .attr("clip-path", "url(#clip)");

                 area.y0(h / 4 - 20);

                 g.select("circle").transition()
                     .duration(duration)
                     .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (-h / 4) + ")"; })
                     .remove();

                 g.select("text").transition()
                     .duration(duration)
                     .attr("transform", function(d) { return "translate(" + (w - 60) + "," + (h / 4 - 20) + ")"; })
                     .attr("dy", "0em");

                 g.each(function(d) {
                   y.domain([0, d.maxPrice]);

                   d3.select(this).selectAll(".area")
                       .data(d3.range(3))
                     .enter().insert("path", ".line")
                       .attr("class", "area")
                       .attr("transform", function(d) { return "translate(0," + (d * (h / 4 - 20)) + ")"; })
                       .attr("d", area(d.values))
                       .style("fill", function(d, i) { return color(i); })
                       .style("fill-opacity", 1e-6);

                   y.domain([0, d.maxPrice / 3]);

                   d3.select(this).selectAll(".line").transition()
                       .duration(duration)
                       .attr("d", line(d.values))
                       .style("stroke-opacity", 1e-6);

                   d3.select(this).selectAll(".area").transition()
                       .duration(duration)
                       .style("fill-opacity", 1)
                       .attr("d", area(d.values))
                       .each("end", function() { d3.select(this).style("fill-opacity", null); });
                 });
                 setTimeout(areas, duration + delay);
     }

     function areas() {
               var g = svg.selectAll(".symbol");

               axis.y(h / 4 - 21);

               g.select(".line")
                    .attr("d", function(d) { return axis(d.values); });

               g.each(function(d) {
                    y.domain([0, d.maxPrice]);

               d3.select(this).select(".line").transition()
                       .duration(duration)
                       .style("stroke-opacity", 1)
                       .each("end", function() { d3.select(this).style("stroke-opacity", null); });

               d3.select(this).selectAll(".area")
                       .filter(function(d, i) { return i; })
                         .transition()
                       .duration(duration)
                       .style("fill-opacity", 1e-6)
                       .attr("d", area(d.values))
                       .remove();

               d3.select(this).selectAll(".area")
                    .filter(function(d, i) { return !i; })
                         .transition()
                    .duration(duration)
                    .style("fill", color(d.key))
                    .attr("d", area(d.values));
               });

               svg.select("defs").transition()
                    .duration(duration)
                    .remove();

               g.transition()
                    .duration(duration)
                    .each("end", function() { d3.select(this).attr("clip-path", null); });

               setTimeout(stackedArea, duration + delay);
          }

          function stackedArea() {
               var stack = d3.layout.stack()
                    .values(function(d) { return d.values; })
                    .x(function(d) { return d.date; })
                    .y(function(d) { return d.price; })
                    .out(function(d, y0, y) { d.price0 = y0; })
                    .order("reverse");

               stack(symbols);

               y.domain([0, d3.max(symbols[0].values.map(function(d) { return d.price + d.price0; }))])
               .range([h, 0]);

            line
                .y(function(d) { return y(d.price0); });

            area
                .y0(function(d) { return y(d.price0); })
                .y1(function(d) { return y(d.price0 + d.price); });

            var t = svg.selectAll(".symbol").transition()
                .duration(duration)
                .attr("transform", "translate(0,0)")
                .each("end", function() { d3.select(this).attr("transform", null); });

            t.select("path.area")
                .attr("d", function(d) { return area(d.values); });

            t.select("path.line")
                .style("stroke-opacity", function(d, i) { return i < 3 ? 1e-6 : 1; })
                .attr("d", function(d) { return line(d.values); });

            t.select("text")
                .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

            setTimeout(streamgraph, duration + delay);
          }

          function streamgraph() {
            var stack = d3.layout.stack()
                .values(function(d) { return d.values; })
                .x(function(d) { return d.date; })
                .y(function(d) { return d.price; })
                .out(function(d, y0, y) { d.price0 = y0; })
                .order("reverse")
                .offset("wiggle");

            stack(symbols);

            line
                .y(function(d) { return y(d.price0); });

            var t = svg.selectAll(".symbol").transition()
                .duration(duration);

            t.select("path.area")
                .attr("d", function(d) { return area(d.values); });

            t.select("path.line")
                .style("stroke-opacity", 1e-6)
                .attr("d", function(d) { return line(d.values); });

            t.select("text")
                .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

            setTimeout(overlappingArea, duration + delay);
          }

          function overlappingArea() {
            var g = svg.selectAll(".symbol");

            line
                .y(function(d) { return y(d.price0 + d.price); });

            g.select(".line")
                .attr("d", function(d) { return line(d.values); });

            y
                .domain([0, d3.max(symbols.map(function(d) { return d.maxPrice; }))])
                .range([h, 0]);

            area
                .y0(h)
                .y1(function(d) { return y(d.price); });

            line
                .y(function(d) { return y(d.price); });

            var t = g.transition()
                .duration(duration);

            t.select(".line")
                .style("stroke-opacity", 1)
                .attr("d", function(d) { return line(d.values); });

            t.select(".area")
                .style("fill-opacity", .5)
                .attr("d", function(d) { return area(d.values); });

            t.select("text")
                .attr("dy", ".31em")
                .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price) + ")"; });

            svg.append("line")
                .attr("class", "line")
                .attr("x1", 0)
                .attr("x2", w - 60)
                .attr("y1", h)
                .attr("y2", h)
                .style("stroke-opacity", 1e-6)
              .transition()
                .duration(duration)
                .style("stroke-opacity", 1);

            setTimeout(groupedBar, duration + delay);
          }

          function groupedBar() {
            x = d3.scale.ordinal()
                .domain(symbols[0].values.map(function(d) { return d.date; }))
                .rangeBands([0, w - 60], .1);

            var x1 = d3.scale.ordinal()
                .domain(symbols.map(function(d) { return d.key; }))
                .rangeBands([0, x.rangeBand()]);

            var g = svg.selectAll(".symbol");

            var t = g.transition()
                .duration(duration);

            t.select(".line")
                .style("stroke-opacity", 1e-6)
                .remove();

            t.select(".area")
                .style("fill-opacity", 1e-6)
                .remove();

            g.each(function(p, j) {
              d3.select(this).selectAll("rect")
                  .data(function(d) { return d.values; })
                .enter().append("rect")
                  .attr("x", function(d) { return x(d.date) + x1(p.key); })
                  .attr("y", function(d) { return y(d.price); })
                  .attr("width", x1.rangeBand())
                  .attr("height", function(d) { return h - y(d.price); })
                  .style("fill", color(p.key))
                  .style("fill-opacity", 1e-6)
                .transition()
                  .duration(duration)
                  .style("fill-opacity", 1);
            });

            setTimeout(stackedBar, duration + delay);
          }

          function stackedBar() {
            x.rangeRoundBands([0, w - 60], .1);

            var stack = d3.layout.stack()
                .values(function(d) { return d.values; })
                .x(function(d) { return d.date; })
                .y(function(d) { return d.price; })
                .out(function(d, y0, y) { d.price0 = y0; })
                .order("reverse");

            var g = svg.selectAll(".symbol");

            stack(symbols);

            y
                .domain([0, d3.max(symbols[0].values.map(function(d) { return d.price + d.price0; }))])
                .range([h, 0]);

            var t = g.transition()
                .duration(duration / 2);

            t.select("text")
                .delay(symbols[0].values.length * 10)
                .attr("transform", function(d) { d = d.values[d.values.length - 1]; return "translate(" + (w - 60) + "," + y(d.price / 2 + d.price0) + ")"; });

            t.selectAll("rect")
                .delay(function(d, i) { return i * 10; })
                .attr("y", function(d) { return y(d.price0 + d.price); })
                .attr("height", function(d) { return h - y(d.price); })
                .each("end", function() {
                  d3.select(this)
                      .style("stroke", "#fff")
                      .style("stroke-opacity", 1e-6)
                    .transition()
                      .duration(duration / 2)
                      .attr("x", function(d) { return x(d.date); })
                      .attr("width", x.rangeBand())
                      .style("stroke-opacity", 1);
                });

            setTimeout(transposeBar, duration + symbols[0].values.length * 10 + delay);
          }

          function transposeBar() {
            x
                .domain(symbols.map(function(d) { return d.key; }))
                .rangeRoundBands([0, w], .2);

            y
                .domain([0, d3.max(symbols.map(function(d) { return d3.sum(d.values.map(function(d) { return d.price; })); }))]);

            var stack = d3.layout.stack()
                .x(function(d, i) { return i; })
                .y(function(d) { return d.price; })
                .out(function(d, y0, y) { d.price0 = y0; });

            stack(d3.zip.apply(null, symbols.map(function(d) { return d.values; }))); // transpose!

            var g = svg.selectAll(".symbol");

            var t = g.transition()
                .duration(duration / 2);

            t.selectAll("rect")
                .delay(function(d, i) { return i * 10; })
                .attr("y", function(d) { return y(d.price0 + d.price) - 1; })
                .attr("height", function(d) { return h - y(d.price) + 1; })
                .attr("x", function(d) { return x(d.symbol); })
                .attr("width", x.rangeBand())
                .style("stroke-opacity", 1e-6);

            t.select("text")
                .attr("x", 0)
                .attr("transform", function(d) { return "translate(" + (x(d.key) + x.rangeBand() / 2) + "," + h + ")"; })
                .attr("dy", "1.31em")
                .each("end", function() { d3.select(this).attr("x", null).attr("text-anchor", "middle"); });

            svg.select("line").transition()
                .duration(duration)
                .attr("x2", w);

            setTimeout(donut,  duration / 2 + symbols[0].values.length * 10 + delay);
          }

          function donut() {
            var g = svg.selectAll(".symbol");

            g.selectAll("rect").remove();

            var pie = d3.layout.pie()
                .value(function(d) { return d.sumPrice; });

            var arc = d3.svg.arc();

            g.append("path")
                .style("fill", function(d) { return color(d.key); })
                .data(function() { return pie(symbols); })
              .transition()
                .duration(duration)
                .tween("arc", arcTween);

            g.select("text").transition()
                .duration(duration)
                .attr("dy", ".31em");

            svg.select("line").transition()
                .duration(duration)
                .attr("y1", 2 * h)
                .attr("y2", 2 * h)
                .remove();

            function arcTween(d) {
              var path = d3.select(this),
                  text = d3.select(this.parentNode.appendChild(this.previousSibling)),
                  x0 = x(d.data.key),
                  y0 = h - y(d.data.sumPrice);

              return function(t) {
                var r = h / 2 / Math.min(1, t + 1e-3),
                    a = Math.cos(t * Math.PI / 2),
                    xx = (-r + (a) * (x0 + x.rangeBand()) + (1 - a) * (w + h) / 2),
                    yy = ((a) * h + (1 - a) * h / 2),
                    f = {
                      innerRadius: r - x.rangeBand() / (2 - a),
                      outerRadius: r,
                      startAngle: a * (Math.PI / 2 - y0 / r) + (1 - a) * d.startAngle,
                      endAngle: a * (Math.PI / 2) + (1 - a) * d.endAngle
                    };

                path.attr("transform", "translate(" + xx + "," + yy + ")");
                path.attr("d", arc(f));
                text.attr("transform", "translate(" + arc.centroid(f) + ")translate(" + xx + "," + yy + ")rotate(" + ((f.startAngle + f.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
              };
            }

            setTimeout(donutExplode, duration + delay);
          }

          function donutExplode() {
            var r0a = h / 2 - x.rangeBand() / 2,
                r1a = h / 2,
                r0b = 2 * h - x.rangeBand() / 2,
                r1b = 2 * h,
                arc = d3.svg.arc();

            svg.selectAll(".symbol path")
                .each(transitionExplode);

            function transitionExplode(d, i) {
              d.innerRadius = r0a;
              d.outerRadius = r1a;
              d3.select(this).transition()
                  .duration(duration / 2)
                  .tween("arc", tweenArc({
                    innerRadius: r0b,
                    outerRadius: r1b
                  }));
            }

            function tweenArc(b) {
              return function(a) {
                var path = d3.select(this),
                    text = d3.select(this.nextSibling),
                    i = d3.interpolate(a, b);
                for (var key in b) a[key] = b[key]; // update data
                return function(t) {
                  var a = i(t);
                  path.attr("d", arc(a));
                  text.attr("transform", "translate(" + arc.centroid(a) + ")translate(" + w / 2 + "," + h / 2 +")rotate(" + ((a.startAngle + a.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
                };
              }
            }

            setTimeout(function() {
              svg.selectAll("*").remove();
              svg.selectAll("g").data(symbols).enter().append("g").attr("class", "symbol");
              lines();
            }, duration);
          }
}